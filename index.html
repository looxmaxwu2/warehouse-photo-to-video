<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fotoğraf → Video</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body class="bg-light py-5">
  <div class="container">
    <div class="card shadow p-4">
      <h2 class="text-center mb-4">Fotoğraf → Video Dönüştürücü</h2>
      <div class="mb-3">
        <label class="form-label">Fotoğraf Yükle</label>
        <input type="file" id="imageInput" accept="image/*" class="form-control"/>
      </div>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Video Süresi (saniye)</label>
          <input type="number" id="duration" class="form-control" value="5" min="1" max="30"/>
        </div>
        <div class="col-md-6">
          <label class="form-label">Video Formatı</label>
          <select id="format" class="form-select">
            <option value="mp4">MP4</option>
            <option value="webm">WebM</option>
            <option value="mov">MOV</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Çözünürlük</label>
          <select id="resolution" class="form-select">
            <option value="original">Orijinal</option>
            <option value="1080">1080p</option>
            <option value="720" selected>720p</option>
            <option value="480">480p</option>
          </select>
        </div>
      </div>
      <button id="convertBtn" class="btn btn-primary w-100 mt-4">Videoya Dönüştür</button>

      <div class="progress mt-3" style="height: 8px; display: none;">
        <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
      </div>

      <div id="status" class="alert mt-3 d-none"></div>

      <video id="preview" controls class="w-100 mt-3 d-none"></video>
      <a id="downloadLink" class="btn btn-success w-100 mt-3 d-none" download>Videoyu İndir</a>
    </div>
  </div>

  <!-- FFmpeg.js -->
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
  <script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({
      log: true,
      corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/'
    });

    const convertBtn = document.getElementById("convertBtn");
    const imageInput = document.getElementById("imageInput");
    const preview = document.getElementById("preview");
    const statusBox = document.getElementById("status");
    const progressBar = document.getElementById("progressBar");
    const downloadLink = document.getElementById("downloadLink");

    convertBtn.addEventListener("click", async () => {
      const file = imageInput.files[0];
      if (!file || !file.type.startsWith("image/")) {
        showStatus("Lütfen geçerli bir fotoğraf seçin!", "danger");
        return;
      }

      const duration = document.getElementById("duration").value;
      const format = document.getElementById("format").value;
      const resolution = document.getElementById("resolution").value;

      convertBtn.disabled = true;
      showStatus("FFmpeg başlatılıyor...", "info");
      document.querySelector(".progress").style.display = "block";

      if (!ffmpeg.isLoaded()) {
        await ffmpeg.load();
      }

      ffmpeg.setProgress(({ ratio }) => {
        progressBar.style.width = `${Math.round(ratio * 100)}%`;
      });

      ffmpeg.FS("writeFile", "input.jpg", await fetchFile(file));

      let scaleFilter = "";
      if (resolution !== "original") {
        scaleFilter = `scale=-2:${resolution}`;
      }

      const args = [
        "-loop", "1",
        "-i", "input.jpg",
        "-t", duration,
        "-vf", `fps=30${scaleFilter ? "," + scaleFilter : ""}`,
        "-c:v",
        format === "mp4" ? "libx264" : format === "webm" ? "libvpx" : "libx264",
        "-pix_fmt", "yuv420p",
        "-preset", "fast",
        "-movflags", "+faststart",
        `output.${format}`
      ];

      try {
        await ffmpeg.run(...args);
        const data = ffmpeg.FS("readFile", `output.${format}`);
        const videoBlob = new Blob([data.buffer], { type: `video/${format}` });
        const videoUrl = URL.createObjectURL(videoBlob);

        preview.src = videoUrl;
        preview.classList.remove("d-none");
        downloadLink.href = videoUrl;
        downloadLink.download = `video.${format}`;
        downloadLink.classList.remove("d-none");

        showStatus("Başarıyla dönüştürüldü!", "success");
      } catch (err) {
        showStatus("Hata: " + err.message, "danger");
      } finally {
        convertBtn.disabled = false;
        document.querySelector(".progress").style.display = "none";
      }
    });

    function showStatus(message, type) {
      statusBox.className = `alert alert-${type} mt-3`;
      statusBox.textContent = message;
      statusBox.classList.remove("d-none");
    }
  </script>
</body>
</html>
